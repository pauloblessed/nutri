<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema Nutricional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="manifest" href="/nutri/manifest.json">
    <meta name="theme-color" content="#8B0000">
    <style>
        body { background-color: #f8f9fa; }
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .slogan {
            text-align: center;
            margin-bottom: 20px;
        }
        .slogan h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #8B0000;
        }
        .slogan p {
            font-size: 1.2rem;
            color: #6c757d;
        }
        .form-label { font-weight: bold; }
        .required::after { content: " *"; color: red; }
        .invalid-feedback { display: none; }
        .is-invalid ~ .invalid-feedback { display: block; }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="slogan">
            <h1>SISTEMA GRATUITO PARA NUTRICIONISTAS</h1>
            <p>Desenvolvido por programadores, estudantes de nutrição e professores</p>
        </div>
        <h2 class="text-center mb-4">Login</h2>
        <div id="mensagem-login"></div>
        <form id="loginForm">
            <div class="mb-3">
                <label for="login" class="form-label">Email:</label>
                <input type="email" class="form-control" id="login" name="login" required>
            </div>
            <div class="mb-3">
                <label for="senha" class="form-label">Senha:</label>
                <input type="password" class="form-control" id="senha" name="senha" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Entrar</button>
            <div class="text-center mt-3">
                <p>ou</p>
                <a href="/nutri/login_google.html" class="btn btn-danger w-100">Entrar com Google</a>
                <p class="mt-3">Não tem uma conta? <a href="#" data-bs-toggle="modal" data-bs-target="#cadastroModal">Cadastrar</a></p>
            </div>
        </form>
    </div>

    <div class="modal fade" id="cadastroModal" tabindex="-1" aria-labelledby="cadastroModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cadastroModalLabel">Cadastro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Campos obrigatórios <span style="color: red;">*</span></p>
                    <div id="mensagem-cadastro"></div>
                    <form id="cadastroForm">
                        <div class="mb-3">
                            <label for="nome" class="form-label required">Nome:</label>
                            <input type="text" class="form-control" id="nome" name="nome" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label required">Email:</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                            <div class="invalid-feedback">Este email já está cadastrado.</div>
                        </div>
                        <div class="mb-3">
                            <label for="senha" class="form-label required">Senha:</label>
                            <input type="password" class="form-control" id="senha" name="senha" required>
                        </div>
                        <div class="mb-3">
                            <label for="cidade_cad" class="form-label required">Cidade:</label>
                            <input type="text" class="form-control" id="cidade_cad" name="cidade_cad" required>
                        </div>
                        <div class="mb-3">
                            <label for="registro_classe" class="form-label">CRN (Registro de Classe):</label>
                            <input type="text" class="form-control" id="registro_classe" name="registro_classe" placeholder="Ex.: CRN-3 12345">
                            <div class="invalid-feedback">CRN inválido. Use o formato CRN-X NNNNN (ex.: CRN-3 12345).</div>
                        </div>
                        <div class="mb-3">
                            <label for="cpf" class="form-label">CPF:</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" placeholder="Ex.: 123.456.789-00">
                            <div class="invalid-feedback">CPF inválido.</div>
                        </div>
                        <div class="mb-3">
                            <label for="timezone" class="form-label">Fuso Horário:</label>
                            <select class="form-control" id="timezone" name="timezone">
                                <option value="America/Sao_Paulo" selected>São Paulo (UTC-3)</option>
                                <option value="America/Manaus">Manaus (UTC-4)</option>
                                <option value="America/Cuiaba">Cuiabá (UTC-4)</option>
                                <option value="America/Porto_Velho">Porto Velho (UTC-4)</option>
                                <option value="America/Rio_Branco">Rio Branco (UTC-5)</option>
                                <option value="America/Recife">Recife (UTC-3)</option>
                                <option value="America/Fortaleza">Fortaleza (UTC-3)</option>
                                <option value="America/Belem">Belém (UTC-3)</option>
                                <option value="America/Noronha">Fernando de Noronha (UTC-2)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Cadastrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/nutri/sw.js')
                    .then(registration => console.log('Service Worker registrado:', registration))
                    .catch(error => console.error('Erro ao registrar Service Worker:', error));
            });
        }

        // Função para validar CPF no cliente
        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]/g, '');
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
                return false;
            }
            let soma = 0, resto;
            for (let i = 1; i <= 9; i++) {
                soma += parseInt(cpf[i-1]) * (11 - i);
            }
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf[9])) return false;
            soma = 0;
            for (let i = 1; i <= 10; i++) {
                soma += parseInt(cpf[i-1]) * (12 - i);
            }
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            return resto === parseInt(cpf[10]);
        }

        // Função para validar CRN no cliente
        function validarCRN(crn) {
            if (!crn) return true;
            return /^CRN-[1-9][0]?[ ]?[0-9]{1,5}$/.test(crn);
        }

        // Verificar se usuário está logado
        const user = localStorage.getItem('user');
        if (user) {
            window.location.href = '/nutri/frame.html';
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('login').value;
            const senha = document.getElementById('senha').value;
            const mensagemLogin = document.getElementById('mensagem-login');

            if (!email || !senha) {
                mensagemLogin.innerHTML = '<div class="alert alert-danger">Preencha todos os campos.</div>';
                return;
            }

            try {
                const response = await fetch('https://blessed.com.br/mobile/api.php?action=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, senha })
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('user', JSON.stringify(data.user));
                    window.location.href = '/nutri/frame.html';
                } else {
                    mensagemLogin.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            } catch (error) {
                mensagemLogin.innerHTML = '<div class="alert alert-danger">Erro ao fazer login.</div>';
            }
        });

        // Cadastro
        document.getElementById('cadastroForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('nome').value;
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            const cidade = document.getElementById('cidade_cad').value;
            const registroClasse = document.getElementById('registro_classe').value;
            const cpf = document.getElementById('cpf').value;
            const timezone = document.getElementById('timezone').value;
            const mensagemCadastro = document.getElementById('mensagem-cadastro');

            if (!nome || !email || !senha || !cidade) {
                mensagemCadastro.innerHTML = '<div class="alert alert-danger">Preencha todos os campos obrigatórios.</div>';
                return;
            }
            if (cpf && !validarCPF(cpf)) {
                document.getElementById('cpf').classList.add('is-invalid');
                return;
            }
            if (registroClasse && !validarCRN(registroClasse)) {
                document.getElementById('registro_classe').classList.add('is-invalid');
                return;
            }

            try {
                const response = await fetch('https://blessed.com.br/mobile/api.php?action=cadastro', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, email, senha, cidade_cad: cidade, registro_classe: registroClasse, cpf, timezone })
                });
                const data = await response.json();
                if (response.ok) {
                    mensagemCadastro.innerHTML = '<div class="alert alert-success">Cadastro realizado com sucesso! Você já pode fazer login.</div>';
                    document.getElementById('cadastroForm').reset();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('cadastroModal'));
                    modal.hide();
                } else {
                    mensagemCadastro.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            } catch (error) {
                mensagemCadastro.innerHTML = '<div class="alert alert-danger">Erro ao realizar cadastro.</div>';
            }
        });

        // Validação de email
        document.getElementById('email').addEventListener('blur', async function() {
            const email = this.value;
            const feedback = this.nextElementSibling;
            if (email) {
                try {
                    const response = await fetch(`https://blessed.com.br/mobile/api.php?action=verificar-email&email=${encodeURIComponent(email)}`);
                    const data = await response.json();
                    if (data.exists) {
                        this.classList.add('is-invalid');
                    } else {
                        this.classList.remove('is-invalid');
                    }
                } catch (error) {
                    console.error('Erro ao verificar email:', error);
                }
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Validação de CPF e CRN
        document.getElementById('cpf').addEventListener('blur', function() {
            const cpf = this.value;
            if (cpf && !validarCPF(cpf)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        document.getElementById('registro_classe').addEventListener('blur', function() {
            const crn = this.value;
            if (crn && !validarCRN(crn)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    </script>
</body>
</html>