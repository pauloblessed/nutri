<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema Nutricional</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="manifest" href="/nutri/manifest.json">
    <meta name="theme-color" content="#8B0000">
    <style>
        body { background-color: #f8f9fa; }
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .slogan {
            text-align: center;
            margin-bottom: 20px;
        }
        .slogan h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #8B0000;
        }
        .slogan p {
            font-size: 1.2rem;
            color: #6c757d;
        }
        .form-label { font-weight: bold; }
        .required::after { content: " *"; color: red; }
        .invalid-feedback { display: none; }
        .is-invalid ~ .invalid-feedback { display: block; }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="slogan">
            <h1>SISTEMA GRATUITO PARA NUTRICIONISTAS</h1>
            <p>Desenvolvido por programadores, estudantes de nutrição e professores</p>
        </div>
        <h2 class="text-center mb-4">Login</h2>
        <div id="mensagem-login"></div>
        <form id="loginForm">
            <div class="mb-3">
                <label for="login" class="form-label">Email:</label>
                <input type="email" class="form-control" id="login" name="login" required>
            </div>
            <div class="mb-3">
                <label for="senha" class="form-label">Senha:</label>
                <input type="password" class="form-control" id="senha" name="senha" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Entrar</button>
            <div class="text-center mt-3">
                <p>ou</p>
                <button type="button" id="loginGoogle" class="btn btn-danger w-100">Entrar com Google</button>
                <p class="mt-3">Não tem uma conta? <a href="#" data-bs-toggle="modal" data-bs-target="#cadastroModal">Cadastrar</a></p>
            </div>
        </form>
    </div>

    <div class="modal fade" id="cadastroModal" tabindex="-1" aria-labelledby="cadastroModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cadastroModalLabel">Cadastro</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Campos obrigatórios <span style="color: red;">*</span></p>
                    <div id="mensagem-cadastro"></div>
                    <form id="cadastroForm">
                        <div class="mb-3">
                            <label for="nome" class="form-label required">Nome:</label>
                            <input type="text" class="form-control" id="nome" name="nome" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label required">Email:</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                            <div class="invalid-feedback">Este email já está cadastrado.</div>
                        </div>
                        <div class="mb-3">
                            <label for="senha" class="form-label required">Senha:</label>
                            <input type="password" class="form-control" id="senha" name="senha" required>
                        </div>
                        <div class="mb-3">
                            <label for="cidade_cad" class="form-label required">Cidade:</label>
                            <input type="text" class="form-control" id="cidade_cad" name="cidade_cad" required>
                        </div>
                        <div class="mb-3">
                            <label for="registro_classe" class="form-label">CRN (Registro de Classe):</label>
                            <input type="text" class="form-control" id="registro_classe" name="registro_classe" placeholder="Ex.: CRN-3 12345">
                            <div class="invalid-feedback">CRN inválido. Use o formato CRN-X NNNNN (ex.: CRN-3 12345).</div>
                        </div>
                        <div class="mb-3">
                            <label for="cpf" class="form-label">CPF:</label>
                            <input type="text" class="form-control" id="cpf" name="cpf" placeholder="Ex.: 123.456.789-00">
                            <div class="invalid-feedback">CPF inválido.</div>
                        </div>
                        <div class="mb-3">
                            <label for="timezone" class="form-label">Fuso Horário:</label>
                            <select class="form-control" id="timezone" name="timezone">
                                <option value="America/Sao_Paulo" selected>São Paulo (UTC-3)</option>
                                <option value="America/Manaus">Manaus (UTC-4)</option>
                                <option value="America/Cuiaba">Cuiabá (UTC-4)</option>
                                <option value="America/Porto_Velho">Porto Velho (UTC-4)</option>
                                <option value="America/Rio_Branco">Rio Branco (UTC-5)</option>
                                <option value="America/Recife">Recife (UTC-3)</option>
                                <option value="America/Fortaleza">Fortaleza (UTC-3)</option>
                                <option value="America/Belem">Belém (UTC-3)</option>
                                <option value="America/Noronha">Fernando de Noronha (UTC-2)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Cadastrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Inicializar Supabase
        const supabase = Supabase.createClient('https://vjpxlkyfjtrhdsyrxsko.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqcHhsa3lmanRyaGRzeXJ4c2tvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4OTUwMDEsImV4cCI6MjA2MDQ3MTAwMX0.HkMPdlcpT75u75z6j5BbBwYW8QLzQGKBJxyHb-St7k0');

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/nutri/sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.error('Erro ao registrar Service Worker:', error);
                    });
            });
        }

        // Função para validar CPF no cliente
        function validarCPF(cpf) {
            cpf = cpf.replace(/[^\d]/g, '');
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) {
                return false;
            }
            let soma = 0, resto;
            for (let i = 1; i <= 9; i++) {
                soma += parseInt(cpf[i-1]) * (11 - i);
            }
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf[9])) return false;
            soma = 0;
            for (let i = 1; i <= 10; i++) {
                soma += parseInt(cpf[i-1]) * (12 - i);
            }
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            return resto === parseInt(cpf[10]);
        }

        // Função para validar CRN no cliente
        function validarCRN(crn) {
            if (!crn) return true; // CRN é opcional
            return /^CRN-[1-9][0]?[ ]?[0-9]{1,5}$/.test(crn);
        }

        // Verificar se usuário está logado
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                window.location.href = 'frame.html';
            }
        });

        // Login com email e senha
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('login').value;
            const senha = document.getElementById('senha').value;
            const mensagemLogin = document.getElementById('mensagem-login');

            if (!email || !senha) {
                mensagemLogin.innerHTML = '<div class="alert alert-danger">Preencha todos os campos.</div>';
                return;
            }

            const { error } = await supabase.auth.signInWithPassword({ email, password: senha });
            if (error) {
                mensagemLogin.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            } else {
                window.location.href = 'frame.html';
            }
        });

        // Login com Google
        document.getElementById('loginGoogle').addEventListener('click', async function() {
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: window.location.origin + '/nutri/frame.html' }
            });
            if (error) {
                document.getElementById('mensagem-login').innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            }
        });

        // Cadastro
        document.getElementById('cadastroForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('nome').value;
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            const cidade = document.getElementById('cidade_cad').value;
            const registroClasse = document.getElementById('registro_classe').value;
            const cpf = document.getElementById('cpf').value;
            const timezone = document.getElementById('timezone').value;
            const mensagemCadastro = document.getElementById('mensagem-cadastro');

            if (!nome || !email || !senha || !cidade) {
                mensagemCadastro.innerHTML = '<div class="alert alert-danger">Preencha todos os campos obrigatórios.</div>';
                return;
            }
            if (cpf && !validarCPF(cpf)) {
                document.getElementById('cpf').classList.add('is-invalid');
                return;
            }
            if (registroClasse && !validarCRN(registroClasse)) {
                document.getElementById('registro_classe').classList.add('is-invalid');
                return;
            }

            const { data: { user }, error } = await supabase.auth.signUp({
                email,
                password: senha,
                options: { data: { nome, cidade_cad: cidade, registro_classe: registroClasse, cpf, timezone, nivel: 'Usuário' } }
            });

            if (error) {
                mensagemCadastro.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            } else {
                await supabase.from('users').insert([{
                    id: user.id,
                    nome,
                    email,
                    cidade_cad: cidade,
                    registro_classe: registroClasse || null,
                    cpf: cpf || null,
                    timezone,
                    nivel: 'Usuário',
                    origem: window.location.host,
                    created_at: new Date().toISOString()
                }]);
                mensagemCadastro.innerHTML = '<div class="alert alert-success">Cadastro realizado com sucesso! Você já pode fazer login.</div>';
                document.getElementById('cadastroForm').reset();
                const modal = bootstrap.Modal.getInstance(document.getElementById('cadastroModal'));
                modal.hide();
            }
        });

        // Validação de email no cliente
        document.getElementById('email').addEventListener('blur', async function() {
            const email = this.value;
            const feedback = this.nextElementSibling;
            if (email) {
                const { data } = await supabase.from('users').select('email').eq('email', email);
                if (data.length > 0) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            } else {
                this.classList.remove('is-invalid');
            }
        });

        // Validação de CPF e CRN no cliente
        document.getElementById('cpf').addEventListener('blur', function() {
            const cpf = this.value;
            if (cpf && !validarCPF(cpf)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });

        document.getElementById('registro_classe').addEventListener('blur', function() {
            const crn = this.value;
            if (crn && !validarCRN(crn)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    </script>
</body>
</html>